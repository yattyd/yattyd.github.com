---
layout: default
title: "QOS限速的最佳设定方法--tomato或者dd-wrt或者openwrt"
tag: "Linux"
categories: "Training"
---

# {{ page.title }}


# QOS限速的最佳设定方法--tomato或者dd-wrt或者openwrt[转]


我讲的比较俗，是为了新人好理解，高手飘过吧。

QOS有两种，一种是原版QOS，这个dd-wrt也有，是基于优先机制来实现的，但一般效果不是很明显，因为分类比较困难，
比如说对80端口的访问就不一定是http访问，有些P2P软件也使用80端口，xunlei就是这样。

另外一种就是限制每个IP的流量和线程的QOS，这种QOS在以前是限制每个IP最大速率，不过这是上一代的算法，现在的算法不仅有限制每个IP的最大速率（最大带宽），
还有一个概念是最小保证速率（保证带宽），这部分带宽是固定分配给每个IP的，就是说运气再差也有这部分带宽保证你不饿死。整体带宽减去所有在线IP的保证带宽之和，剩下
的带宽就是所有的IP竞争了。

这里所说的整体带宽也就是参考带宽，就是电信运营商给你的带宽大小，分上行和下载。
“带宽单位为kbit，如4M ADSL就是4000kbit”这是Tomato DualWan作者的注释，但是，实际的情况不是这样的，实际的情况是在中国的大多数地方比这个要小
（听说Tomato DualWan的作者是人，估计没这种情况吧）。至于原因嘛，要去问我们那可爱的运营商老大了，不过估计得不到有意义的回答的。

下面是一些1-4M的ADSL宽带的实际和理论带宽表（适用于中国大多数注意1Byte=8bit)
                     理论上行             实际上行                   理论下载                      实际下载
1Madsl          512kbit/s或64KB/S       320kbit/s 或40KB/S             1024kbit/s或128KB/S             880kbit/s或110KB/S
2Madsl          512kbit/s或64KB/S       320kbit/s 或40KB/S             2048kbit/s或256KB/S             1640kbit/s或205KB/S
3Madsl          512kbit/s或64KB/S       320kbit/s 或40KB/S             3072kbit/s或384KB/S             2400kbit/s或300KB/S
4Madsl          512kbit/s或64KB/S       320kbit/s 或40KB/S             4096kbit/s或512KB/S             3200kbit/s或400KB/S

一般来说，上行都是40KB/S，下载在运营商眼中1M==100KB/S。如何测试运营商给你的实际带宽，我提供两种方法，1.，英文网站，按向导自己去看。2.疯狂的BT下载，比如同时开BT，和网络电视，PC上安装一些可以观察流量的软件，比如网络执法官，netpeeker等，这样可以测的最大下载。至于最大上传，可以使用飞速上传3个电影来观察。注意前提是你没有作任何设置，并且这条带宽只有你的PC在用。

说完了实际的参考带宽，再说一下常见应用所使用的连接数（线程数）。这里的连接数是网络地址转换（NAT）表的数目。打开一个网页：一般是5个左右的TCP连接，当然flash比较多的可达30个以上。当然这只是短时间（5秒左右）的最高值。打开网页在瞬时带宽可达到50KByte/S，打开后就不怎么占带宽了。玩网络游戏，开QQ：一般少于10个。占用带宽极少一般低于5KB/S。BT下载：少则几十个，多则几百甚至上千。占用带宽极大，有多少占多少。除了P2P下载，一般应用都不怎么占用带宽和连接数。

建议：tcp限制至少在50以上，一般100为佳（公司设置为50就行了）。UDP不太好限制，Tomato DualWan是限制每秒发UDP的数量，一般可以不限制。当然有些是udp和tcp一起限制，比如TP-link的那些企业级的路由器，建议公司100，网吧或者个人可以更大一些。

累了，要去睡觉了。
明天我再来写我用实验方法得到的最优化的设定。
这个设定的效果是：一条2Madsl，两个IP的最大下载带宽之和超过了2M，但是，我使用3个PC来疯狂P2P下载，
第4个PC的网络延迟值在100ms以下（这个延迟下玩网络游戏不卡啊）。

先提出几个观点：
1.上传对下载有影响，下载对上传也有影响。当然，我们要浏览网站，更重要的是下载，而不是上传。但如果建设网站就是上传更重要了，服务器更占上传带宽。下面有两个经验性观点：
观点1---当一台PC疯狂占用上传速率的时候，另一台PC的下载达不到最大下载速率。
观点2---大多数的P2P下载，在占满你下载速率的时候，真正需要的上传速率非常的小，只有1KB/S左右，
其余的带宽都是由于你P2P下载的同时，你也扮演了“服务器”的角色，别人也从你的电脑上“拉：你下载的资源。
2.很多时候，网络延迟比网络带宽更影响我们上网的体验。什么是网络延迟，说得俗一点，就是打CS的时候的ping值。一般在命令行里ping一下当地的DNS或者大型网站，看返回的time值。广东的可以ping 202.96.134.134。在什么都不干的时候（确认P2P没后台进程在偷偷上传），这个值是比较稳定的，ADSL一般在25ms以下才算正常。
3.带宽占用率（也称“带宽负载”）与网络延迟的关系。
其实这个流量控制的算法有很大关系，与流量算法中的队列长度，排队算法，优先策略等有关系。这个东西也是一门专业的学问。
通过实验，我的结论是：当带宽占用率不超过50%时候，延迟几乎不变；当带宽占用率超过80%的时候，网络延迟上升明显。其中，上传占用率对网络延迟的影响更大。

最后通过实验，得到一条2MADSL的带宽设定如下：
我测得实际参考带宽是上传45KB/S,下载205KB/S
按照80%的结论，我的参考带宽设置是（深圳家庭ADSL）：
上传：280kbit/s（略小于80%），下载1400kbit/s（约为85%)
当然，最大程度的占用带宽，可以设置为上传320kbit/s，下载1600kbit/s，其中上传不建议设置为360kbit/s，因为上传对网络延迟的影响更大，而延迟过大将影响TCP协议的效率，切记。

最后再说tomato中每个IP最大和最小带宽设定原则：
所有最小带宽之和不要超过参考带宽，最大带宽不要超过参考带宽的80%.
我的最小带宽设定：上传20kbit/s,下载80kbit/s
最大带宽设定：上传120kbit/s，下载1100kbit/s.
设定的效果是：一条2Madsl，两个IP的最大下载带宽之和超过了2M，但是，我使用3个PC来疯狂P2P下载，第4个PC的网络延迟值在100ms以下。

注意我的结论是在深圳的普通ADSL上成立，具体数值在不同地区，不同种类线路上有所不同。
比如ADSL专线，光纤专线肯定不一样，因为电信运营商对待不同线路的策略不同，这也是为什么2MADSL和2M光纤同样是2M，价格却是大大地不同，当然固定IP是其中一个原因。（据说深圳电信2M光纤5000RMB/月）。
